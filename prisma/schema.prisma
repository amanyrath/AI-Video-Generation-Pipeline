generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String         @id @default(uuid())
  name      String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  carModels CarModel[]
  assets    CompanyAsset[]
  projects  Project[]
  users     User[]
}

model User {
  id         String      @id @default(uuid())
  email      String      @unique
  name       String
  password   String
  role       UserRole    @default(MEMBER)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  companyId  String
  projects   Project[]   @relation("ProjectOwner")
  shareLinks ShareLink[] @relation("ShareLinksCreated")
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([email])
}

model CompanyAsset {
  id        String    @id @default(uuid())
  type      AssetType
  value     Json?
  s3Key     String?
  filename  String?
  mimeType  String?
  size      Int?
  createdAt DateTime  @default(now())
  companyId String
  company   Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
}

model CarModel {
  id        String       @id @default(uuid())
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  companyId String
  company   Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  variants  CarVariant[]

  @@index([companyId])
}

model CarVariant {
  id        String     @id @default(uuid())
  year      Int
  trim      String
  createdAt DateTime   @default(now())
  modelId   String
  media     CarMedia[]
  model     CarModel   @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId])
}

model CarMedia {
  id        String       @id @default(uuid())
  type      CarMediaType
  s3Key     String
  filename  String
  mimeType  String
  size      Int
  createdAt DateTime     @default(now())
  variantId String
  variant   CarVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([variantId])
  @@index([type])
}

model Project {
  id                   String          @id @default(uuid())
  name                 String
  prompt               String
  targetDuration       Int
  status               ProjectStatus   @default(STORYBOARD)
  finalVideoUrl        String?
  finalVideoS3Key      String?
  characterDescription String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  companyId            String
  ownerId              String
  company              Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  owner                User            @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  scenes               Scene[]
  shareLinks           ShareLink[]
  textOverlays         TextOverlay[]
  timelineClips        TimelineClip[]
  uploadedImages       UploadedImage[]

  @@index([companyId])
  @@index([ownerId])
  @@index([status])
}

model Scene {
  id                  String           @id @default(uuid())
  sceneNumber         Float
  sceneTitle          String
  sceneSummary        String
  imagePrompt         String
  suggestedDuration   Float
  negativePrompt      String?
  customDuration      Float?
  customImageInput    String?
  useSeedFrame        Boolean          @default(false)
  status              SceneStatus      @default(PENDING)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  projectId           String
  videoPrompt         String
  modelParameters     Json?
  isDuplicate         Boolean          @default(false)
  parentSceneId       String?
  referenceImageUrls  Json?
  generatedImages     GeneratedImage[]
  generatedVideos     GeneratedVideo[]
  project             Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  seedFrames          SeedFrame[]
  timelineClips       TimelineClip[]

  @@unique([projectId, sceneNumber])
  @@index([projectId])
  @@index([status])
}

model GeneratedImage {
  id          String   @id @default(uuid())
  url         String
  s3Key       String?
  localPath   String?
  prompt      String
  replicateId String
  isSelected  Boolean  @default(false)
  createdAt   DateTime @default(now())
  sceneId     String
  scene       Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
  @@index([isSelected])
}

model GeneratedVideo {
  id            String         @id @default(uuid())
  url           String
  s3Key         String?
  localPath     String?
  duration      Float?
  prompt        String?
  isSelected    Boolean        @default(false)
  createdAt     DateTime       @default(now())
  sceneId       String
  scene         Scene          @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  timelineClips TimelineClip[]

  @@index([sceneId])
  @@index([isSelected])
}

model SeedFrame {
  id         String   @id @default(uuid())
  url        String
  s3Key      String?
  frameIndex Int
  isSelected Boolean  @default(false)
  createdAt  DateTime @default(now())
  sceneId    String
  scene      Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)

  @@index([sceneId])
}

model TimelineClip {
  id        String         @id @default(uuid())
  title     String
  startTime Float
  duration  Float
  trimStart Float?
  trimEnd   Float?
  order     Int
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  projectId String
  sceneId   String
  videoId   String
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scene     Scene          @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  video     GeneratedVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([sceneId])
  @@index([order])
}

model TextOverlay {
  id                String   @id @default(uuid())
  text              String
  startTime         Float
  duration          Float
  x                 Float    @default(0.5)
  y                 Float    @default(0.85)
  fontSize          Int      @default(48)
  fontFamily        String   @default("Arial")
  fontColor         String   @default("#FFFFFF")
  backgroundColor   String?
  backgroundOpacity Float    @default(0.0)
  textAlign         String   @default("center")
  fontWeight        String   @default("normal")
  borderWidth       Int      @default(0)
  borderColor       String?
  opacity           Float    @default(1.0)
  rotation          Float    @default(0.0)
  shadowEnabled     Boolean  @default(false)
  shadowOffsetX     Int      @default(2)
  shadowOffsetY     Int      @default(2)
  shadowBlur        Int      @default(4)
  shadowColor       String   @default("#000000")
  animationIn       String?
  animationOut      String?
  order             Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  projectId         String
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([order])
}

model UploadedImage {
  id           String   @id @default(uuid())
  url          String
  s3Key        String?
  originalName String
  mimeType     String
  size         Int
  createdAt    DateTime @default(now())
  projectId    String
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model ShareLink {
  id          String   @id @default(uuid())
  shareToken  String   @unique
  createdAt   DateTime @default(now())
  projectId   String
  createdById String
  createdBy   User     @relation("ShareLinksCreated", fields: [createdById], references: [id], onDelete: Cascade)
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([projectId])
  @@index([createdById])
}

model FileStorage {
  id                String                  @id @default(uuid())
  s3Key             String                  @unique
  localPath         String?
  category          FileCategory
  mimeType          String
  size              Int
  contentHash       String?
  isUploaded        Boolean                 @default(false)
  isDeleted         Boolean                 @default(false)
  createdAt         DateTime                @default(now())
  uploadedAt        DateTime?
  deletedAt         DateTime?
  projectId         String
  sceneId           String?
  processedVersions ProcessedImageVersion[] @relation("OriginalFile")

  @@index([projectId])
  @@index([sceneId])
  @@index([category])
  @@index([contentHash])
  @@index([isUploaded])
}

model ProcessedImageVersion {
  id             String         @id @default(uuid())
  s3Key          String         @unique
  localPath      String?
  processingType ProcessingType
  iteration      Int            @default(1)
  mimeType       String         @default("image/png")
  size           Int
  isUploaded     Boolean        @default(false)
  createdAt      DateTime       @default(now())
  uploadedAt     DateTime?
  originalFileId String
  projectId      String
  sceneId        String?
  originalFile   FileStorage    @relation("OriginalFile", fields: [originalFileId], references: [id], onDelete: Cascade)

  @@index([originalFileId])
  @@index([projectId])
  @@index([sceneId])
  @@index([processingType])
  @@index([iteration])
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  ADMIN
  MEMBER
}

enum AssetType {
  LOGO
  COLOR_SCHEME
  BADGE
  OTHER
}

enum CarMediaType {
  EXTERIOR
  INTERIOR
  SOUND
  THREE_D_MODEL
}

enum ProjectStatus {
  STORYBOARD
  SCENE_GENERATION
  STITCHING
  COMPLETED
}

enum SceneStatus {
  PENDING
  GENERATING_IMAGE
  IMAGE_READY
  GENERATING_VIDEO
  VIDEO_READY
  COMPLETED
}

enum FileCategory {
  UPLOADS
  GENERATED_IMAGES
  GENERATED_VIDEOS
  FRAMES
  PROCESSED
  TIMELINE_EDITS
  PREVIEWS
  FINAL
}

enum ProcessingType {
  ORIGINAL
  BG_REMOVED
  EDGE_CLEANED
  UPSCALED
  RECOLORED
}
